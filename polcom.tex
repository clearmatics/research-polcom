% !TeX spellcheck = en_UK
% \let\accentvec\vec              
\documentclass[runningheads,11pt]{llncs}
%\let\spvec\vec \let\vec\accentvec
\newcommand\hmmax{0}
\newcommand\bmmax{0}

\usepackage{amssymb,amsmath}
%\let\vec\spvec
%\usepackage{lmodern}
\usepackage{newtxmath,newtxtext}
\usepackage[T1]{fontenc}
% \def\vec#1{\mathchoice{\mbox{\mathbf$\displaystyle#1$}}
% {\mbox{\mathbf$\textstyle#1$}} {\mbox{\mathbf$\scriptstyle#1$}}
% {\mbox{\mathbf$\scriptscriptstyle#1$}}}

\DeclareFontFamily{U}{mathx}{\hyphenchar\font45}
\DeclareFontShape{U}{mathx}{m}{n}{<-> mathx10}{}
\DeclareSymbolFont{mathx}{U}{mathx}{m}{n}
\DeclareMathAccent{\widebar}{0}{mathx}{"73}

\usepackage{soulutf8} \soulregister\cite7 \soulregister\ref7
\soulregister\pageref7 \usepackage{hyperref}
\usepackage[color=yellow]{todonotes} \hypersetup{final} \usepackage{mathrsfs}
\usepackage[advantage,asymptotics,adversary,sets,keys,ff,lambda,primitives,events,operators,probability,logic,mm,complexity]{cryptocode}

\usepackage{cite} 
\usepackage{booktabs}
\usepackage{paralist}
\usepackage[innerleftmargin=5pt,innerrightmargin=5pt]{mdframed}
\usepackage{caption}
\captionsetup{belowskip=0pt}
\usepackage{bm}
\usepackage{url}
%\usepackage{dirtytalk}
\newcommand{\say}[1]{\emph{``#1''}}
\usepackage[margin=0.7in,a4paper]{geometry}
\usepackage[normalem]{ulem}
\usepackage{dashbox}
\newcommand{\dboxed[1]}{\dbox{\ensuremath{#1}}}
\usepackage{hyperref}
\usepackage[capitalise]{cleveref}
\usepackage{braket} %for the \braket{} command

%\usepackage{mathptmx}


\include{macros}
\include{macros_antonio}

\title{On PHP-based zkSNARKs}

\author{} 
%\iflncs{
\institute{} 

\allowdisplaybreaks

\begin{document} \sloppy \maketitle

\begin{abstract}
  In this paper we investigate properties of zkSNARKs obtained by
  compiling a PHP proof using a polynomial commitment scheme. The question we
  try to answer is \say{What polynomial commitment's properties propagate to
    the resulting zkSNARK?}. The properties we focus on are:
  \begin{compactenum}
  \item simulation extractability,
  \item SRS updatability,
  \item SRS-updatable simulation extractability,
  \item subversion zero knowledge.
  \end{compactenum}
  The research hypothesis is \say{A NIZK obtained from a simulation extractable /
    SRS-updatable / SRS updatable SE / subversion zero knowledge polynomial
    commitment is simulation extractable /
    SRS-updatable / SRS updatable SE / subversion zero knowledge.} To be able to
  show the hypothesis we need to solve a number of problems
  \begin{compactenum}
  \item Neither simulation extractability, SRS-updatability, SRS-updatable
    simulation extractability, nor subversion zero knowledge have been defined
    for a polynomial commitment scheme. Another contribution of the paper is
    defining these properties. 
  \item Similarly, there is no definition for SRS-updatable simulation
    extractable NIZKs.
  \item The polynomial IOP is defined very generally, cf.~\cref{def:piop}, what
    makes showing generic properties difficult. The paper would propose tighter
    definitions which would emphasize more the structure of PHP,
    but would not narrow a class of possible (from the practical point of view)
    PHP too much, cf.~\cref{def:wepiop,def:sdwepiop}.
  \end{compactenum}
  
\end{abstract}

\section{Preliminaries}
\paragraph{Polynomial commitment scheme.}
\label{sec:poly_com}
In the polynomial commitment scheme $\PCOM = (\kgen, \com, \open, \verify)$ the
prover $\prover$ convinces the verifier $\verifier$ that some polynomial $\p{f}$
which $\prover$ committed to evaluates to $s$ at some point $z$ chosen by
$\verifier$.  The key generation algorithm $\kgen$ takes as input a security
parameter $\secparam$ and a parameter $\maxdeg$ which determines the maximal
degree of the committed polynomial. We assume that $\maxdeg$ can be read from
the output SRS.
  
We emphasize the following properties of a secure polynomial commitment
$\PCOM$:
\begin{description}
\item[Evaluation binding:] A $\ppt$ adversary $\adv$ which outputs a commitment
  $\vec{c}$ and evaluation points $\vec{z}$ has at most negligible chances to
  open the commitment to two different evaluations $\vec{s}, \vec{s'}$. That is,
  let $k \in \NN$ be the number of committed polynomials, $l \in \NN$ number of
  evaluation points, $\vec{c} \in \GRP^k$ be the commitments,
  $\vec{z} \in \FF_p^l$ be the arguments the polynomials are evaluated at,
  $\vec{s},\vec{s}' \in \FF_p^k$ the evaluations, and
  $\vec{o},\vec{o}' \in \FF_p^l$ be the commitment openings. Then for every
  $\ppt$ adversary $\adv$
	\[
		\Pr
			\left[
			\begin{aligned}
				& \verify(\srs, \vec{c}, \vec{z}, \vec{s}, \vec{o}) = 1,  \\ 
				& \verify(\srs, \vec{c}, \vec{z}, \vec{s}', \vec{o}') = 1, \\
				& \vec{s} \neq \vec{s}'
			\end{aligned}
			\,\left|\,\vphantom{\begin{aligned}
                  & \\
                  & \\
                  &
                \end{aligned}}
			\begin{aligned}
				& \srs \gets \kgen(\secparam, \maxdeg),\\
				& (\vec{c}, \vec{z}, \vec{s}, \vec{s}', \vec{o}, \vec{o}') \gets \adv(\srs)
			\end{aligned}
			\right.\right] \leq \negl\,.
	\]

\end{description}
	

\begin{description}
\item[Commitment of knowledge] For every $\ppt$ adversary
  $\adv = (\adv_1, \adv_2)$ who produces commitment $c$, gets random evaluation
  point $z$, and outputs evaluation $s$ with an opening $o$ there exists a
  $\ppt$ extractor $\ext$ such that
\[
  \Pr \left[
    \begin{aligned}
      & \p{f} = \ext_\adv(\srs, c, (r_1, r_2)),\\
      & c = \com(\srs, \p{f}),\\
      & \verify(\srs, c, z, s, o) = 1
    \end{aligned}
    \,\left|\,
      \vphantom{
        \begin{aligned}
          & \\
          & \\
          &
        \end{aligned}
        }
    \begin{aligned}
      & \srs \gets \kgen(\secparam, \maxdeg),\\
      & (c, \aux) \gets \adv_1(\srs; r_1), z \sample \FF, \\
      &  (s, o) \gets \adv_2(\srs, \aux, c, z; r_2)
    \end{aligned}
  \right.\right]
  \geq 1 - \epsk(\secpar).
\]
In that case we say that $\PCOM$ is $\epsk$-knowledge.
\end{description}
Intuitively when a commitment scheme is a commitment of knowledge then if an
adversary produces a (valid) commitment $c$, which it can open, then it also
knows the underlying polynomial $\p{f}$ which commits to that value.

\section{New definitions and primitives}
\subsection{Polynomial commitment schemes}

\begin{definition}[Simulation extractable polynomial commitment]
  \label{def:sepcom}
  Let $\PCOM = (\kgen, \com, \open, \verify)$ be a polynomial commitment
  scheme with a simulator $\mathsf{SimSample}, \mathsf{SimOpen}$. Let $\maxdeg$ be a maximal degree of polynomials that can be
  committed.
  Let $\oracles$ be an oracle which on input
  \begin{description}
%   \item [$(\msg{commit}, f)$:] returns commitment $c = \com(f)$ and adds $(f,
% c)$ to list $Q$.
\item[$(\msg{commit})$:] Run $C_{i} \gets \mathsf{SimSample}(\secparam)$
  \item[$(\msg{open}, c, x, y)$:] returns an opening $o$ for commitment $c$
    assuring that for some polynomial $f$, such that $c \in \image(\com(f))$,
    holds $f(x) = y$.
  \end{description}
  We say that $\PCOM$ is \emph{simulation extractable} if for any $\ppt$
  adversary $\adv$ with oracle access to $\oracles$ there exists extractor
  $\ext$ such that
\[
  \Pr \left[
    \begin{aligned}
      & \p{f} = \ext_\adv(\srs, c; r),\\
      & c = \com(\srs, \p{f}),\\
      & \verify(\srs, c, z, s, o) = 1,\\
      & z \not\in \Qev
    \end{aligned}
    \,\left|\,
      \vphantom{
        \begin{aligned}
          & \\
          & \\
          & \\
          &
        \end{aligned}
        }
    \begin{aligned}
      & \srs \gets \kgen(\secparam, \maxdeg),\\
      & (c, z, s, o) \gets \adv^{\oracles}(\srs; r), \\
      % & z \sample \FF,\\
      % & (s, o) \gets \adv^{\oracles}(\srs, z; r)
    \end{aligned}
  \right.\right]
  \geq 1 - \epsk(\secpar).
\]
\end{definition}



\begin{definition}[Simulation extractable polynomial commitment]
  \label{def:sepcom}
  Let $\PCOM = (\kgen, \com, \open, \verify)$ be a polynomial commitment
  scheme. Let $\maxdeg$ be a maximal degree of polynomials that can be
  committed, $H$ be a set of $\maxdeg + 1$ elements in $\FF$ and
  $\van{H}$ is a vanishing polynomial for $H$.
  
  Let $\oracles$ be an oracle which on input
  \begin{description}
%   \item [$(\msg{commit}, f)$:] returns commitment $c = \com(f)$ and adds $(f,
% c)$ to list $Q$.
\item[$(\msg{commit}, f, d)$:] for $\deg(f) = d'$, $d' \leq d \leq \maxdeg$,
  picks $d - d'$ random elements $r_1, \ldots, r_{d - d'}$, sets 
  polynomial $g(X) = f(X) + \van{H}(r_1 X^{d' + 1} + \ldots + r_{d - d'} X^{d})$, returns
  commitment $c = \com(g)$ and adds $(g, c)$ to list $\Qcom$.
  \item[$(\msg{evaluate}, c, z)$:] returns $f(z)$ where $f$ is a polynomial
    which commitment is $c$ and $(f, c) \in \Qcom$; add $z$ to $\Qev$.
  \item[$(\msg{open}, c, x, y)$:] returns an opening $o$ for commitment $c$
    assuring that for some polynomial $f$, such that $c \in \image(\com(f))$,
    holds $f(x) = y$.
  \end{description}
  We say that $\PCOM$ is \emph{simulation extractable} if for any $\ppt$
  adversary $\adv = (\adv_1, \adv_2)$ with oracle access to $\oracles$ there
  exists extractor $\ext$ such that
\[
  \Pr \left[
    \begin{aligned}
      & \p{f} = \ext_\adv(\srs, c, (r_1, r_2)),\\
      & c = \com(\srs, \p{f}),\\
      & \verify(\srs, c, z, s, o) = 1,
    \end{aligned}
    \,\left|\,
      \vphantom{
        \begin{aligned}
          & \\
          & \\
          & \\
          &
        \end{aligned}
        }
    \begin{aligned}
      & \srs \gets \kgen(\secparam, \maxdeg),\\
      & (c, \aux) \gets \adv_1^{\oracles}(\srs; r_1), \\
      & z \sample \FF, \\
      & (s, o) \gets \adv_2^{\oracles}(\srs, c, z, \aux; r_2)
    \end{aligned}
  \right.\right]
  \geq 1 - \epsk(\secpar).
\]
  \michals{23.04}{Can $\ext$ ask $\adv$ to give evaluations of the committed
    polynomial? That is how $\ext$ in a proof system works -- it evaluates
    polynomials submitted by the adversary on multiple challenges.}
\end{definition}

 \begin{definition}[One-to-many openable\hl{Good name needed}]
   We call a commitment scheme $\PCOM$ one-to-many openable \hl{good name
     needed} if for any $\adv$ who outputs commitments $c_1, \ldots, c_k$,
   evaluation point $z$, evaluations $s_1, \ldots, s_k$ and batch opening $o$,
   which certifies that polynomials $f_i$ evaluates at $z$ to $s_i$ and
   $c_i \in \image(\com(f_i))$, there exists $\ppt$ algorithm $\bdv$ that
   produces valid openings $o_i$ for each triple $(c_i, z, s_i)$.
 \end{definition}
 Intuitively, we say that a polynomial commitment is one-to-many openable if we
 can deduce that adversary who successfully batch opens a number of polynomial
 commitments could also successfully open each of the commitments separately.

 \michals{23.06}{That's easy for KZG batched as in Plonk (with minor difference)
   -- just get a number of batch openings and do Gaussian elimination.}

 \begin{definition}
\hl{The proof system and the polynomial commitment scheme use virtually the same
SRS. (Both SRS could differ in some efficiency related elements, but computation
of these don't require any secret knowledge)}
\michals{12.07}{Check how it is done in Lunar}
   \end{definition}

\subsection{Polynomial IOP}
 \begin{definition}[$\eps$-sufficiently simulatable PCOM]
   Let $\PCOM$ be a SE polynomial commitment scheme and
   $\PS = (\kgen, \prover, \verifier, \simulator)$ a polynomial zero-knowledge proof system
   for relation $\REL$. We call $\PCOM$ \emph{$\eps$-sufficiently simulatable for
     $\PS$} if there exist a $\ppt$ algorithm $\adv$ such that for
   $\srs \sample \kgen$, all $(\inp, \wit) \in \REL$ holds
   \[
     \SD_{\srs \sample \kgen(\secparam)}(\prover(\srs, \inp, \wit),
     \adv^{\oracles}(\srs, \inp)) \leq \eps(\secpar).
   \]
 \end{definition}
 Intuitively, we call $\PCOM$ sufficiently simulatable for $\PS$ if a $\ppt$
 $\adv$ given access to $\PCOM$'s simulator oracle $\oraclespcom$ can produce a
 simulated proof for $\PS$.

 \begin{definition}[Polynomial Holomorphic Proof System (PHP)]
  \label{def:php}
  Let $\REL$ be an indexed relation with a corresponding language $\LANG$, $\FF$
  some finite field, $\maxdeg$ a degree bound, $\vereq_{\cdot}(X) \in \FF[X]$ a
  verification equation, and $\eps, \noofp$ parameters.
  \michals{12.07}{Continue}
\end{definition}

\begin{definition}[Witness encoding PHP (WEPHP)]
  \label{def:wephp}
  Let $\PS$ be a PHP.  We say that $\PS$ is \emph{witness encoding} if there is
  a function $\decode$ and set $\encset \in [\noofp]$ such that for any
  $(\inp, \wit) \in \REL$ and polynomials $\smallset{f_i}_{i \in [\noofp]}$ sent by an
  honest prover, $\decode(\smallset{f_i}_{i \in \encset}) = \wit$. We call $\encset$ the
  \emph{encoding set}.
\end{definition}
In other words, PHP is witness encoding if for any valid proof for a statement
$\inp$ in the language, the corresponding witness can be read from the
polynomial coefficients. We note that this is the case for virtually all
PHPs. \michals{28.04}{Check!}

\antonio{27.07}{This definition reminded me that in Lunar we define straight-line extractability for PHP.
	The def is stronger than def above.  I think that every "natural" PHP should
	also be straight-line extractable. I copy-paste the definition below:}
	%
\begin{definition}[PHPs with straight-line extractor]
\label{def:knownsound_wc_poly}
A $\PS$ is $\epsilon$-knowledge-sound with straight-line extractor if there exists an
extractor $\WitExtract$ such that for any prover $\Pphp^*$, every field $\FF \in \Fam$,
relation $\ind$, and instance $\inp$: 
\[ \Prob{ (\ind, \inp, \WitExtract(\tuple\pora{\nprv})) \in \relfam}
	\geq \Prob{ \braket{ \Pphp^*,\Vphp^{\Iphp(\FF,\ind)}(\FF,\inp) } = 1} - \epsilon
\]
where $\tuple\pora{\nprv}$ are the polynomials output by $\Pphp^*$ in an execution of
$\braket{\Pphp^*, \Vphp^{\Iphp(\FF,\ind)}(\FF,\inp)}$.
\end{definition}



\begin{definition}[Somehow deterministic WEPHP]
  \label{def:sdwephp}
  Let $\PS$ be a WEPHP for $\REL$. For each polynomial $f_i$ sent by the prover
  denote by $A_i$ the set of challenges sent by the verifier and by $F_i$ the
  set of polynomials sent by the prover \emph{before} the prover sends
  $f_i$. Let $\encset$ be an encoding set. We say that $\PS$ is \emph{somehow
    deterministic} (SD) if for any $(\inp, \wit) \in \REL$, polynomials
  $\smallset{f_i}_{i \in [\noofp]}$ send by the prover, and encoding set
  $\encset \neq [\noofp]$ each polynomial
  $f_j \in \smallset{f_i}_{i \in [\noofp] \setminus \encset}$ is determined by
  \begin{itemize}
    \item polynomials $F_j$, and
    \item the verifier's challenges $A_i$, and
    \item the witness $\wit$.
  \end{itemize}
\end{definition}
Intuitively, we say that WEPHP is somehow deterministic if the only
non-deterministic messages send by the prover are polynomials encoding the
witness, and all other messages are determined by the previous one, witness, and
verifier's challenges.

\section{PHP-to-NIZK compiler}

\subsection{From PHP to zkPHP}
\michals{24.06}{Need to show how to get a ZK PHP from PHP}

\begin{theorem}[From WEPHP to ZK WEPHP]
  Let $\PHP = (\prover, \verifier)$ be a WEPHP and $E$ its encoding set,
  $\maxdeg$ be a maximal degree of polynomials sent by the prover; and
  let $\PHP = (\prover', \verifier')$ be a WEPHP such that
  \begin{itemize}
  \item Both parties get as input a set of $\FF$ elements $H$, such that
    $\abs{H} = \maxdeg + 1$. Denote the vanishing polynomial for $H$ by $\van{H}$.
  \item $\prover'$ acts as $\prover$ except for $f_i(X) \in E$. Let $k_i$ be a
    number of queries $\verifier$ makes to the oracle $\oracleo_{f_i}$ and
    $d_i = \deg(f_i)$, then $\prover'$ computes
      \[
        g_i(X) = f_i(X) + \van{H}\left(X^{d_i + 1} b_1 + \ldots
        X^{d_i + k_i + 1} b_{k_i + 1}\right)
      \]
      for random $b_1, \ldots, b_{k + 1}$ and sets oracle $\oracleo_{g_i}$.
    \item $\verifier'$ acts as $\verifier$. \michals{28.06}{We don't want to
        change the verifier and its equations -- that's why we have $\van{H}$.}
  \end{itemize}
\end{theorem}
\begin{proof}
  \ncase{Completeness} 

  \ncase{Soundness} 

  \ncase{Zero-knowledge} To show the property we construct a simulator
  $\simulator$ and argue that it produces proofs indistinguishable from proofs
  of a real prover. The simulator behaves as real prover, except for
  witness-encoding polynomials in $\smallset{f_i}_{i \in E}$. For
  $f_j \in \smallset{f_i}_{i \in E}$, where it
  \begin{itemize}
  \item Picks randomizers $b_1, \ldots, b_{\noofq_j}$ and computes polynomial
    $g_i(X) =  \van{H}(b_1 X + \ldots b_{\noofq_j} X^{\noofq_j})$. 
  \item \michals{28.06}{The simulator can open the commitment to any value, but
      he need to know *which* value}
  \end{itemize}
  
\end{proof}

\subsection{Simulation extractable NIZKs from simulation extractable polynomial
  commitments}

\begin{theorem}
  Let $\PHP = (\PHP.\prover, \PHP.\verifier, \PHP.\simulator)$ be a ZK PHP
  for $\REL$ with knowledge soundness error $\epsks$ where the prover sends up
  to $\noofp$ polynomials. Let $\PCOM$ be $\eps(\secpar)$-sufficiently
  simulatable polynomial commitment scheme for $\PS$ with extraction error
  $\epsext$. Let $\PS = (\PS.\prover, \PS.\verifier, \PS.\simulator)$ be a proof system such
  that
  \begin{enumerate}
  \item $\PS.\prover$ acts as $\PHP.\prover$, except
    \begin{itemize}
    \item when $\PHP.\prover$ sets up a polynomial oracle $\oracleo_f$,
      $\PS.\prover$ sends commitment $c = \com(f)$;
    \item when $\PS.\verifier$ asks $\PS.\prover$ to open a commitment
      $c = \com(f)$ at $z$ it returns $f(z)$ and a proof $o$ of correctness of
      the opening.
  \end{itemize}
  \item $\PS.\verifier$ acts as $\PHP.\verifier$, except when $\PHP.\verifier$
    asks oracle $\oracleo_f$ for an evaluation of $f$ at $z$, $\PS.\verifier$
    sends $z$ to $\PS.\prover$ and expects $f(z)$ in return.
  \item $\PS.\simulator$ acts as $\PHP.\simulator$, except
     \begin{itemize}
    \item when $\PHP.\simulator$ sets up a polynomial oracle $\oracleo_f$,
      $\PS.\simulator$ sends commitment $c = \com(f)$;
    \item when $\PS.\verifier$ asks $\PS.\simulator$ to open a commitment
      $c = \com(f)$ at $z$ it returns $f(z)$ and a proof $o$ of correctness of
      the opening.
  \end{itemize}
  \end{enumerate}
  Then $\PS$ is simulation extractable with extraction error at most \hl{...}.
\end{theorem}
\begin{proof}
  From the simulation extractability of $\PCOM$ we will derive simulation
  extractability of $\PS$ by constructing a $\PS$ extractor $\ext^{\PS}$ using
  $\PCOM$ extractor $\ext^{\PCOM}$.

  Let $\adv(\srs)$ be a $\PS$ adversary with oracle access to a $\PS$ simulator
  $\simulator$. We show construction of an extractor $\ext^{\PS}$ which from
  acceptable proof $\zkproof$ for instance $\inp$ output by $\adv$ produces
  witness $\wit$ such that $\REL(\inp, \wit) = 1$. We proceed by game hoping.
  
  \ngame{1} Let $\ext^{\PS}_\adv$ be an extractor for adversary $\adv$. In this
  game the adversary is given oracle $\oraclesps$ and produces an instance
  $\inp$ and proof $\zkproof$. $\adv$ wins if $\ext_\adv$ does not output the
  corresponding witness $\wit$.

  \ngame{2} In this game $\adv$'s access to $\oraclesps$ is substituted by
  access to $\bdv^\oraclespcom$ which simulates $\oraclesps$.
  Since $\PCOM$ is sufficiently simulatable for $\PS$, probability that $\adv$
  wins in Game $\game{1}$ but not in $\game{2}$ (or vice-versa) is at most
  $\eps(\secpar)$.

  \medskip\noindent We now analyze the probability that $\adv$ wins in Game
  $\game{2}$. Since $\PCOM$ is simulation extractable, there exists an extractor
  $\ext_\bdv$ which extracts, for $i \in \range{1}{\noofp}$, polynomials $f_i$
  if $\bdv$ output
  \begin{inparaenum}[(1)]
  \item commitment $c_i$ and $c_i \in \image(\com(f_i))$;
  \item evaluations $s_i$ for evaluation points $z_i$ provided by the $\PS.\verifier$;
  \item openings $o_i$;
  \end{inparaenum}
  \michals{28.06}{Stopped here -- we need more details of PHP to argue about
    $\bdv$ returning a valid opening of commitment. Further we want to state
    that if the proof was accepted then the commitments have been opened
    successfully. If the proof system allow for batch opening, then still we can
  open every single commitment.}
  
\end{proof}
\newcommand{\Kzg}{\mathsf{KZG}} \newcommand{\kzg}{\mathsf{kzg}}

\def\cgen{{\sf ComGen}}
\def\commit{{\sf Com}}
%\def\comopen{{\sf ComOpen}}
%\def\openver{{\sf OpenVer}}
% \newcommand{\comkg}{\mathsf{KG}}
\newcommand{\PC}{\mathsf{PC}}
\newcommand{\CM}{\commit}

\def\open{{\sf Open}}
\def\check{{\sf Check}}
%\def\witness{{\sf wit}}
\def\gk{{\sf gk}}

\def\ck{{\sf ck}}
\newcommand{\secp}{\lambda}

\section{KZG commitments are simulation extractable}
$\Kzg.\PC = (\Kzg.\cgen,\Kzg.\CM,\allowbreak  \Kzg.\open,\allowbreak \Kzg.\check)$ is defined over bilinear groups $\gk=(p,\GG_1,\allowbreak \GG_2, \allowbreak \GG_T )$ with $\GG_1 =\langle g\rangle, \GG_2 =\langle h \rangle$ as follows:
\begin{description}%[topsep=5pt]
\item[$\Kzg.\cgen(1^\secpar, n) \to (\ck_\kzg, \vk_\kzg)$:] Set keys
$\ck_\kzg = \{g^{\alpha^i}\}_{i=0}^{n-1}, \allowbreak\vk_\kzg = h^\alpha$.
\item[$\Kzg.\CM(\ck_\kzg; f(X)) \to C_f$:]  For $f(X) = \sum_{i=0}^{n-1} f_i X^i$, computes  $C_f=\prod _{i=0}^{n-1} g^{f_i \alpha^i} = g^{f(\alpha)} $.
\item[$\Kzg.\open(\ck_\kzg; C_f, x, y; f(X)) \to \pi$:] For an evaluation point $x$, a value $y$, compute the quotient  polynomial $q(X) = \displaystyle\frac{f(X) -y }{X-x}$ and output a proof $\pi = C_q = \Kzg.\CM(\ck_\kzg; q(X)) $.
\item[$\Kzg.\check(\vk_\kzg = h^\alpha, C_f, x, y, \pi) \to 1/0$:] Check if $e(C_f \cdot  g^{-y}, h)=e(C_q , h^{\alpha}\cdot h^{-x})$.
\end{description}

We move toward considering a symbolic verification equation $V'$ for which we have:
$V(C_{f},x,y,\pi) =  e(C_f \cdot  g^{-y}, h) - e(C_q , h^{\alpha}\cdot h^{-x}) = 0$ iff $V'(K * Transcript (T)) = 0$.

The trapdoors variables $T$ consist of the trapdoor variable $X$ of the setup and the randomness variables $A_{i}$ of simulated proofs:
$T=(X, \{A_{i}\})$

The transcript consists of the setup $\{[X^{i}]_{1}\}, [X]_{2}$ and simulated proofs $\{[A_{i} + y_{i}]_{1}, [\frac{A_{i}}{X-x_{i}}]\}$.

The honest verification equation is
$[f(X) - y]_1 \circ [h]_{2} - [q(X)]_1 \circ [X-x]_{2}=0$ while an adversary can
provide rational functions
$f(X, \{A_{i}\}) = \sum C_{1i} X^{i} + \sum C_{2i} A_{i} + \sum C_{3i}
\frac{A_{i}}{X-x_{i}}$ and
$q(X, \{A_{i}\}) = \sum Q_{1i} X^{i} + \sum Q_{2i} A_{i} + \sum Q_{3i}
\frac{A_{i}}{X-x_{i}}$ computed as linear combinations of elements in the
transcript. Note that we performed a simplification here as the $y_{i}$ are
picked and known by the adversary.

The security game gives us that $x \neq x_{i}$.

We inline to get the following equation which we then analyze in detail,
\begin{align*}
  \left[\sum C_{1i} X^{i} + \sum C_{2i} A_{i} + \sum C_{3i} \frac{A_{i}}{X-x_{i}} - y\right]_{1} \circ [1]_{2} - \left[\sum Q_{1i} X^{i} + \sum Q_{2i} A_{i} + \sum Q_{3i} \frac{A_{i}}{X-x_{i}}\right]_{1} \circ [X-x]_{2} = 0
  \end{align*}

We now look at diferent monomials in $T$ of this equation to derive constraints on $C_{ji}$ and $Q_{ji}$ imposed by the verification equation:
\begin{itemize}
  \item[$A_{i}X$:] $Q_{2i} A_{i} X = 0$
  \item[$A_{i}$:] $C_{2i} A_{i} = - Q_{2i}A_{i} x$. As $Q_{2i}=0$, it follows
    that $C_{{2i}}=0$. This step relies on $x \neq x_{i}$ and thus
    $\frac{A_{i} (X-x)}{X-x_{i}}$ cannot cancel out its denominator.
  \item[$\frac{A_{i}X}{X-x_{i}}$:] $Q_{3i} \frac{A_{i} X}{X-x_{i}} = 0$.
  \item[$\frac{A_{i}}{X-x_{i}}$:]
    $C_{3i} \frac{A_{i}}{X-x_{i}} = Q_{{3i}} \frac{A_{i}}{X-x_{i}} $. As
    $Q_{3i}=0$, it follows that $C_{{3i}}=0$.
  \end{itemize}
We are thus back to the honest verification equation.

\section{Simulation extractability of $\plonk$ from simulation extractability of
  KZG}
\michals{19.07}{Write down modified version of $\plonk$ where every polynomial
  send by the prover is randomized}
Let $\bdv$ be a deterministic adversary against SE of the polynomial commitment $\PCOM$ and
$\adv$ be an adversary against SE of the proof system $\PS$. We show that
existence of the extractor $\ext_\bdv$ implies existence of $\ext_\adv$. To that
end we show that $\bdv^{\oracles^{\PCOM}}$ can be used to make simulated proofs
for $\adv$.

$\bdv$ on $\adv$'s query $(\inp, \wit)$ proceeds as follows
\begin{enumerate}
\item Send $(\msg{commit}, 0, 2)$ to $\oracles^{\PCOM}$ three times and obtain commitments $c_a$,
  $c_b$, $c_c$ which play roles of commitments to the witness-carrying
  polynomials $\p{a}(X)$, $\p{b}(X)$, $\p{c}(X)$.
\item Compute challenges $\beta, \gamma$ by querying the random oracle.
\item Send $(\msg{commit}, 0, 3)$ to $\oracles^{\PCOM}$ and get commitment $c_z$
  which plays the role of commitment to $\p{z}(X)$.
\item Compute challenge $\alpha$.
\item Send $(\msg{commit}, 0, 2)$ to $\oracles^{\PCOM}$ three times and obtain
  commitments $c_{tlo}$, $c_{tmid}$, $c_{thi}$ which play roles of commitments
  to polynomials $\p{t'_{lo}}(X)$, $\p{t'_{mid}}(X)$, $\p{t'_{hi}}(X)$.
\item Compute challenge $\chz$.
\item Ask $\oracles^{\PCOM}$ for evaluations of $\ev{a}, \ev{b}, \ev{c},
  \ev{t'_{lo}}, \ev{t'_{mid}}, \ev{t'_{hi}}$ of  $c_a, c_b, c_c, c_{tlo},
  c_{tmid}, c_{thi}$ at $\chz$.
\item Compute $\p{t}(\chz)$ and $\p{r}(\chz)$. 
\item Set $\ev{t'} = \ev{t'_{lo}} + \chz^\noofc
  \ev{t'_{mid}} + \chz^{2 \noofc} \ev{t'_{hi}}$.
\item Compute
  $\p{r'}(\chz) = \p{r}(\chz) + (\p{t'_{lo}}(\chz) - \p{t_{lo}}(\chz)) +
  (\p{t'_{mid}}(\chz) - \p{t_{mid}}(\chz))\chz^\noofc + (\p{t'_{hi}}(\chz) - \p{t_{hi}}(\chz))\chz^{2\noofc}$.
\end{enumerate}
  
\bibliographystyle{alpha}
\bibliography{cryptobib/abbrev1,cryptobib/crypto}

\end{document}
